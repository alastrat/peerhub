generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum GlobalRole {
  SUPER_ADMIN
  USER
}

enum CompanyRole {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum CycleStatus {
  DRAFT
  NOMINATION
  IN_PROGRESS
  CLOSED
  ARCHIVED
}

enum ReviewAssignmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  DECLINED
}

enum NominationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReviewerType {
  SELF
  MANAGER
  PEER
  DIRECT_REPORT
  EXTERNAL
}

enum QuestionType {
  RATING
  TEXT
  COMPETENCY_RATING
  MULTIPLE_CHOICE
}

// ============================================
// CORE ENTITIES
// ============================================

model Company {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  logo         String?
  primaryColor String?  @default("#0066FF")
  domain       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users       CompanyUser[]
  departments Department[]
  templates   Template[]
  cycles      Cycle[]
  invitations Invitation[]
  tokens      ReviewToken[]

  @@index([slug])
}

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  name          String?
  image         String?
  globalRole    GlobalRole @default(USER)
  emailVerified DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  accounts  Account[]
  sessions  Session[]
  companies CompanyUser[]

  @@index([email])
}

model CompanyUser {
  id           String      @id @default(cuid())
  userId       String
  companyId    String
  role         CompanyRole @default(EMPLOYEE)
  title        String?
  employeeId   String?
  managerId    String?
  departmentId String?
  startDate    DateTime?
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  company       Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  manager       CompanyUser? @relation("ManagerRelation", fields: [managerId], references: [id])
  directReports CompanyUser[] @relation("ManagerRelation")
  department    Department?  @relation(fields: [departmentId], references: [id])

  cycleParticipations CycleParticipant[]
  reviewsGiven        ReviewAssignment[] @relation("ReviewerAssignments")
  reviewsReceived     ReviewAssignment[] @relation("RevieweeAssignments")
  nominationsGiven    Nomination[]       @relation("NominatorRelation")
  nominationsReceived Nomination[]       @relation("NomineeRelation")
  nominationsFor      Nomination[]       @relation("RevieweeNominations")

  @@unique([userId, companyId])
  @@index([companyId])
  @@index([managerId])
  @@index([departmentId])
}

model Department {
  id          String   @id @default(cuid())
  name        String
  description String?
  parentId    String?
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company  Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parent   Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children Department[] @relation("DepartmentHierarchy")
  members  CompanyUser[]

  @@index([companyId])
  @@index([parentId])
}

// ============================================
// TEMPLATES
// ============================================

model Template {
  id          String   @id @default(cuid())
  name        String
  description String?
  companyId   String
  isDefault   Boolean  @default(false)
  isArchived  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company  Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sections TemplateSection[]
  cycles   Cycle[]

  @@index([companyId])
}

model TemplateSection {
  id            String         @id @default(cuid())
  templateId    String
  title         String
  description   String?
  order         Int
  reviewerTypes ReviewerType[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  template  Template           @relation(fields: [templateId], references: [id], onDelete: Cascade)
  questions TemplateQuestion[]

  @@index([templateId])
}

model TemplateQuestion {
  id           String       @id @default(cuid())
  sectionId    String
  text         String
  description  String?
  type         QuestionType
  isRequired   Boolean      @default(true)
  order        Int
  config       Json?
  competencyId String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  section    TemplateSection  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  competency Competency?      @relation(fields: [competencyId], references: [id])
  responses  ReviewResponse[]

  @@index([sectionId])
}

model Competency {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String?
  companyId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  questions TemplateQuestion[]

  @@index([companyId])
}

// ============================================
// REVIEW CYCLES
// ============================================

model Cycle {
  id          String      @id @default(cuid())
  name        String
  description String?
  companyId   String
  templateId  String
  status      CycleStatus @default(DRAFT)

  nominationStartDate DateTime?
  nominationEndDate   DateTime?
  reviewStartDate     DateTime
  reviewEndDate       DateTime
  reportReleaseDate   DateTime?

  selfReviewEnabled    Boolean @default(true)
  managerReviewEnabled Boolean @default(true)
  peerReviewEnabled    Boolean @default(true)
  directReportEnabled  Boolean @default(false)
  externalEnabled      Boolean @default(false)

  minPeers           Int @default(3)
  maxPeers           Int @default(8)
  anonymityThreshold Int @default(3)

  employeeNominatePeers Boolean @default(true)
  managerApprovePeers   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company      Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  template     Template           @relation(fields: [templateId], references: [id])
  participants CycleParticipant[]
  nominations  Nomination[]
  assignments  ReviewAssignment[]

  @@index([companyId])
  @@index([status])
}

model CycleParticipant {
  id            String    @id @default(cuid())
  cycleId       String
  companyUserId String
  isReviewee    Boolean   @default(true)
  isReviewer    Boolean   @default(true)
  releasedAt    DateTime?
  createdAt     DateTime  @default(now())

  cycle       Cycle       @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  companyUser CompanyUser @relation(fields: [companyUserId], references: [id], onDelete: Cascade)

  @@unique([cycleId, companyUserId])
  @@index([cycleId])
  @@index([companyUserId])
}

model Nomination {
  id              String           @id @default(cuid())
  cycleId         String
  nominatorId     String
  nomineeId       String
  revieweeId      String
  reviewerType    ReviewerType
  status          NominationStatus @default(PENDING)
  rejectionReason String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  cycle     Cycle       @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  nominator CompanyUser @relation("NominatorRelation", fields: [nominatorId], references: [id])
  nominee   CompanyUser @relation("NomineeRelation", fields: [nomineeId], references: [id])
  reviewee  CompanyUser @relation("RevieweeNominations", fields: [revieweeId], references: [id])

  @@unique([cycleId, nomineeId, revieweeId])
  @@index([cycleId])
  @@index([status])
}

// ============================================
// REVIEWS
// ============================================

model ReviewAssignment {
  id                String                 @id @default(cuid())
  cycleId           String
  reviewerId        String?
  revieweeId        String
  reviewerType      ReviewerType
  status            ReviewAssignmentStatus @default(PENDING)
  externalEmail     String?
  externalName      String?
  tokenId           String?                @unique
  declineReason     String?
  startedAt         DateTime?
  completedAt       DateTime?
  lastSavedAt       DateTime?
  draftResponses    Json?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  cycle     Cycle             @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  reviewer  CompanyUser?      @relation("ReviewerAssignments", fields: [reviewerId], references: [id])
  reviewee  CompanyUser       @relation("RevieweeAssignments", fields: [revieweeId], references: [id])
  token     ReviewToken?      @relation(fields: [tokenId], references: [id])
  responses ReviewResponse[]

  @@unique([cycleId, reviewerId, revieweeId])
  @@index([cycleId])
  @@index([reviewerId])
  @@index([revieweeId])
  @@index([status])
}

model ReviewResponse {
  id              String   @id @default(cuid())
  assignmentId    String
  questionId      String
  ratingValue     Int?
  textValue       String?
  selectedOptions String[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  assignment ReviewAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  question   TemplateQuestion @relation(fields: [questionId], references: [id])

  @@unique([assignmentId, questionId])
  @@index([assignmentId])
}

// ============================================
// TOKEN-BASED ACCESS
// ============================================

model ReviewToken {
  id        String    @id @default(cuid())
  token     String    @unique
  email     String
  name      String?
  companyId String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  company    Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignment ReviewAssignment?

  @@index([token])
  @@index([email])
}

// ============================================
// INVITATIONS
// ============================================

model Invitation {
  id           String      @id @default(cuid())
  email        String
  companyId    String
  role         CompanyRole @default(EMPLOYEE)
  departmentId String?
  managerId    String?
  token        String      @unique @default(cuid())
  expiresAt    DateTime
  acceptedAt   DateTime?
  createdAt    DateTime    @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([email, companyId])
  @@index([token])
}

// ============================================
// NEXTAUTH REQUIRED MODELS
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
